---
- name: Check if machine_ops exists
  stat:
    path: /etc/machine_ops
  register: repo_stat

- name: Download machine_ops repo
  git:
    repo: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      31653262646264373665373834343335623431376534623331656333306463303530313266393036
      3333626432653661356337643839363432313030323933310a663830633139653330393933666338
      30343034326331613338666435396431663032356463623134623135383732333762366638326461
      3662613636666263300a353932646531623931653961376135353433646134336230396666313230
      66613230386566646533356131343337353062383665393963303833643331336666653331363036
      63646236383139633331396233396139303336313037663863373935386434376332613665356261
      613033343738643131333364666635373265
    dest: /etc/machine_ops
  when: not repo_stat.stat.exists

- name: Update machine_ops repo
  git:
    repo: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      31653262646264373665373834343335623431376534623331656333306463303530313266393036
      3333626432653661356337643839363432313030323933310a663830633139653330393933666338
      30343034326331613338666435396431663032356463623134623135383732333762366638326461
      3662613636666263300a353932646531623931653961376135353433646134336230396666313230
      66613230386566646533356131343337353062383665393963303833643331336666653331363036
      63646236383139633331396233396139303336313037663863373935386434376332613665356261
      613033343738643131333364666635373265
    dest: /etc/machine_ops
    update: yes
  when: repo_stat.exists

- name: Check that rabbitmq_tools exists
  stat:
    path: /etc/rabbitmq_tools
  register: rabbit_stat

- block:
    - name: Creating /etc/rabbitmq_tools
      file:
        path: /etc/rabbitmq_tools
        state: directory
        mode: "0755"

    - name: Creating /etc/rabbitmq_tools/publishers
      file:
        path: /etc/rabbitmq_tools/publishers
        state: directory
        mode: "0755"

    - name: Creating /etc/rabbitmq_tools/consumers
      file:
        path: /etc/rabbitmq_tools/consumers
        state: directory
        mode: "0755"
  when: not rabbit_stat.exists

- name: Get publishers deployed
  find:
    paths:
      - /etc/rabbitmq_tools/publishers
    recurse: no
  register: publishers_installed

- name: "Setting the number of the next publisher"
  set_fact:
    venv_path: "/etc/rabbitmq_tools/publishers/pub_{{ publishers_installed|length + 1 }}"
  tags:
    - create

- name: Create venv for publisher
  pip: requirement=/etc/machine_ops/infrastructure/requirements.txt virtualenv={{ venv_path }}

- name: Start publisher
  command: "source {{ venv }}/bin/activate && python /etc/machine_ops/infrastructure/master_publisher.py"
